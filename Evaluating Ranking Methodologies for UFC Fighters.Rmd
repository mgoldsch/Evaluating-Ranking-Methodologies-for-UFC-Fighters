---
title: "Evaluating Ranking Methodologies for UFC Fighters"
author: "Michael Goldschlager"
date: "4/19/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Libraries

```{r}
library(elo)
library(PlayerRatings)
library(foreach)
library(doSNOW)
library(parallel)
```

## Load Data

```{r}
ufc_data <- read.csv("data.csv")[, c("R_fighter", "B_fighter", "date", "Winner")]
```

## Data Prep

```{r}
ufc_data$R_win <- 0
ufc_data$R_win[which(ufc_data$Winner == "Red")] <- 1
ufc_data$R_win[which(ufc_data$Winner == "Draw")] <- .5

ufc_data$B_win <- 0
ufc_data$B_win[which(ufc_data$Winner == "Blue")] <- 1
ufc_data$B_win[which(ufc_data$Winner == "Draw")] <- .5

ufc_data$date <- as.Date(ufc_data$date)
ufc_data$date_numeric <- as.numeric(ufc_data$date)

ufc_data <- ufc_data[order(ufc_data$date), ]

ufc_data$R_elo_before <- NA
ufc_data$B_elo_before <- NA

ufc_data$R_elo_after <- NA
ufc_data$B_elo_after <- NA
```

## Elo

```{r}
#Elo generation
fighters <- unique(c(ufc_data$R_fighter, ufc_data$B_fighter))
fighter_elo <- data.frame(fighter = fighters, elo = 1500)

k_list <- seq(170, 250, 5)

cluster <- makeCluster(detectCores() -1)
registerDoSNOW(cluster)

iterations <- length(k_list)
pb <- txtProgressBar(max = iterations, style = 3)
progress <- function(n) setTxtProgressBar(pb, n)
opts <- list(progress = progress)

elo_performance_df <- foreach(i =  1:length(k_list), .combine = 'rbind', .packages = 'elo', .export = c("ufc_data", "fighter_elo"), .options.snow = opts) %dopar% {
  fighter_elo_loop <- fighter_elo
  ufc_data_loop <- ufc_data
  for(j in 1:nrow(ufc_data_loop)) {
    elo_before_r <- fighter_elo_loop[which(fighter_elo_loop$fighter == ufc_data_loop[j,]$R_fighter),]$elo
    elo_before_b <- fighter_elo_loop[which(fighter_elo_loop$fighter == ufc_data_loop[j,]$B_fighter),]$elo
    
    ufc_data_loop[j,]$R_elo_before <- elo_before_r
    ufc_data_loop[j,]$B_elo_before <- elo_before_b
    
    new_elo <- elo.calc(
      wins.A = ufc_data_loop[j,]$R_win,
      elo.A = elo_before_r,
      elo.B = elo_before_b,
      k = k_list[i]
    )
    
    fighter_elo_loop[which(fighter_elo_loop$fighter == ufc_data_loop[j,]$R_fighter),]$elo <- new_elo[1, 1]
    fighter_elo_loop[which(fighter_elo_loop$fighter == ufc_data_loop[j,]$B_fighter),]$elo <- new_elo[1, 2]
    
    ufc_data_loop[j,]$R_elo_after <- new_elo[1, 1]
    ufc_data_loop[j,]$B_elo_after <- new_elo[1, 2]
  }
  
  # Elo Performance
  ufc_data_loop$elo_predict_winner <- NA
  ufc_data_loop$elo_predict_winner[ufc_data_loop$R_elo_before > ufc_data_loop$B_elo_before] <-  "Red"
  ufc_data_loop$elo_predict_winner[ufc_data_loop$B_elo_before > ufc_data_loop$R_elo_before] <- "Blue"
  ufc_data_loop$elo_predict_winner[ufc_data_loop$R_elo_before == ufc_data_loop$B_elo_before] <- "Draw"
  
  ufc_data_loop$elo_prediction_accurate <- NA
  ufc_data_loop$elo_prediction_accurate[ufc_data_loop$elo_predict_winner == ufc_data_loop$Winner] <- 1
  ufc_data_loop$elo_prediction_accurate[ufc_data_loop$elo_predict_winner != ufc_data_loop$Winner] <- 0
  
  cbind(method = "elo" , k = k_list[i], accuracy = mean(ufc_data_loop$elo_prediction_accurate))
}

close(pb)
stopCluster(cluster)

elo_performance_df <- as.data.frame(elo_performance_df)
```
k = 175, best

## Glicko

```{r}
#fighters <- unique(c(ufc_data$R_fighter, ufc_data$B_fighter))

rd_init_vals <- seq(30, 150, 10)
cval_vals <- seq(0, 10, 1)
glicko_params <- expand.grid(rd = rd_init_vals, cval = cval_vals)

cluster <- makeCluster(detectCores() -1)
registerDoSNOW(cluster)

iterations <- nrow(glicko_params)
pb <- txtProgressBar(max = iterations, style = 3)
progress <- function(n) setTxtProgressBar(pb, n)
opts <- list(progress = progress)

glicko_performance <- foreach(i = 1:nrow(glicko_params), .combine = 'rbind', .packages = 'PlayerRatings', .options.snow = opts) %dopar% {
  
  status_df <- NULL
  glicko_rating <- NULL
  #fighter_glicko_loop <- data.frame(fighter = fighters, glicko = 1500, glicko_deviation = glicko_params[i, ]$rd)
  ufc_data_loop <- ufc_data
  ufc_data_loop$R_glicko_pred_win_prob <- NA
  
  for(j in 1:nrow(ufc_data_loop)){
    # #before match ratings
    # ufc_data_loop[j,]$R_glicko_before <- fighter_glicko_loop[which(fighter_glicko_loop$fighter == ufc_data_loop[j,]$R_fighter),]$glicko
    # ufc_data_loop[j,]$B_glicko_before <- fighter_glicko_loop[which(fighter_glicko_loop$fighter == ufc_data_loop[j,]$B_fighter),]$glicko
    # 
    # ufc_data_loop[j,]$R_glicko_deviation_before <-
    #   fighter_glicko_loop[which(fighter_glicko_loop$fighter == ufc_data_loop[j,]$R_fighter),]$glicko_deviation
    # 
    # ufc_data_loop[j,]$B_glicko_deviation_before <- 
    #   fighter_glicko_loop[which(fighter_glicko_loop$fighter == ufc_data_loop[j,]$B_fighter),]$glicko_deviation
    
    #fight
    fight <- ufc_data_loop[j, c("date", "R_fighter", "B_fighter", "R_win")]
    fight$date <- as.numeric(fight$date)
    
    #rating prediction
    if(!is.null(glicko_rating)){
      ufc_data_loop[j, ]$R_glicko_pred_win_prob <- predict(glicko_rating, fight[, -4], tng = 1, trat = c(1500, glicko_params[i, ]$rd))
    }
    
    #rating generation
    gl <- glicko(fight, status = status_df, init = c(1500, glicko_params[i, ]$rd), cval = glicko_params[i, ]$cval)
    
    #glicko_rating for future predictions
    glicko_rating <- gl
    
    #status for future input
    status_df <- gl$ratings
    
    # #update fighter rating df
    # fighter_glicko_loop[which(fighter_glicko_loop$fighter == ufc_data_loop[j,]$R_fighter),]$glicko <- 
    #   status_df[which(status_df$Player == ufc_data_loop[j,]$R_fighter), ]$Rating
    # 
    # fighter_glicko_loop[which(fighter_glicko_loop$fighter == ufc_data_loop[j,]$B_fighter),]$glicko <- 
    #   status_df[which(status_df$Player == ufc_data_loop[j,]$B_fighter), ]$Rating
    # 
    # fighter_glicko_loop[which(fighter_glicko_loop$fighter == ufc_data_loop[j,]$R_fighter),]$glicko_deviation <- 
    #   status_df[which(status_df$Player == ufc_data_loop[j,]$R_fighter), ]$Deviation
    # 
    # fighter_glicko_loop[which(fighter_glicko_loop$fighter == ufc_data_loop[j,]$B_fighter),]$glicko_deviation <- 
    #   status_df[which(status_df$Player == ufc_data_loop[j,]$B_fighter), ]$Deviation
    
    # #after match ratings
    # ufc_data_loop[j,]$R_glicko_after <- fighter_glicko_loop[which(fighter_glicko_loop$fighter == ufc_data_loop[j,]$R_fighter),]$glicko
    # ufc_data_loop[j,]$B_glicko_after <- fighter_glicko_loop[which(fighter_glicko_loop$fighter == ufc_data_loop[j,]$B_fighter),]$glicko
    # 
    # ufc_data_loop[j,]$R_glicko_deviation_after <-
    #   fighter_glicko_loop[which(fighter_glicko_loop$fighter == ufc_data_loop[j,]$R_fighter),]$glicko_deviation
    # 
    # ufc_data_loop[j,]$B_glicko_deviation_after <- 
    #   fighter_glicko_loop[which(fighter_glicko_loop$fighter == ufc_data_loop[j,]$B_fighter),]$glicko_deviation
  }
  
  #Glicko Performance
  ufc_data_loop$glicko_predict_winner <- NA
  ufc_data_loop$glicko_predict_winner[ufc_data_loop$R_glicko_pred_win_prob > .5] <-  "Red"
  ufc_data_loop$glicko_predict_winner[ufc_data_loop$R_glicko_pred_win_prob < .5] <- "Blue"
  ufc_data_loop$glicko_predict_winner[ufc_data_loop$R_glicko_pred_win_prob == .5] <- "Draw"

  ufc_data_loop$glicko_prediction_accurate <- NA
  ufc_data_loop$glicko_prediction_accurate[ufc_data_loop$glicko_predict_winner == ufc_data_loop$Winner] <- 1
  ufc_data_loop$glicko_prediction_accurate[ufc_data_loop$glicko_predict_winner != ufc_data_loop$Winner] <- 0

  cbind(method = "glicko" ,
        rd = glicko_params[i, ]$rd,
        cval = glicko_params[i, ]$cval,
        accuracy = mean(ufc_data_loop$glicko_prediction_accurate, na.rm = TRUE))
}

close(pb)
stopCluster(cluster)

as.data.frame(glicko_performance)
```

best is rd 30, cval 0- 66% accuracy

```{python}
from whr import whole_history_rating
import pandas as pd
import numpy as np

ufc_data_py = pd.DataFrame(r.ufc_data)
ufc_data_py = ufc_data_py[["R_fighter", "B_fighter", "Winner", "date_numeric"]]
#drop draws
ufc_data_py = ufc_data_py[ufc_data_py["Winner"] != "Draw"]
ufc_data_py["Winner_WHR"] = np.where(ufc_data_py["Winner"] == "Red", "B", "W")

whr = whole_history_rating.Base({'w2':14})

for index, fight in ufc_data_py.iterrows():
  whr.create_game(fight["R_fighter"], fight["B_fighter"], fight["Winner_WHR"], fight["date_numeric"], 0)

whr.auto_iterate(time_limit = 10 precision = 10E-3)


```

